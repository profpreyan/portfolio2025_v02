<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Case Studies</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #ff0000;
      transition: background 300ms ease;
    }
    #canvas {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      display: block;
      z-index: 0;
      cursor: default;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <script src="https://unpkg.com/@rive-app/webgl2"></script>
  <script>
    const canvas = document.getElementById("canvas");
    let r;
    let viewModelInstance;
    let isActive = 0;

    /* ---------- Utils ---------- */
    function addMQListener(mq, cb) {
      if (mq.addEventListener) mq.addEventListener("change", cb);
      else if (mq.addListener) mq.addListener(cb);
    }
    function updateBrowserDimensions() {
      const browserWidth  = window.innerWidth  || document.documentElement.clientWidth  || document.body.clientWidth;
      const browserHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
      if (viewModelInstance) {
        try { viewModelInstance.number("artboardWidth").value  = browserWidth; } catch {}
        try { viewModelInstance.number("artboardHeight").value = browserHeight; } catch {}
      }
      return { browserWidth, browserHeight };
    }
    let { browserWidth, browserHeight } = updateBrowserDimensions();

    /* ---------- Cursor: pointer only ---------- */
    function setPointer(active) {
      canvas.style.cursor = active ? "pointer" : "default";
    }

    const entryExitCursorEvents = new Map([
      ["lkdent", true], ["lkdext", false],
      ["rsment", true], ["rsmext", false],
      ["cseent", true], ["cseext", false],
      ["styent", true], ["styext", false],
      ["p1ent",  true], ["p1ext",  false],
      ["p2ent",  true], ["p2ext",  false],
      ["p3ent",  true], ["p3ext",  false],
    ]);

    const hoverEventNames = new Set(["lkdhov","rsmhov","styhov","csehov","p1hov","p2hov","p3hov"]);
    const cursorPointerSignals = ["hover","pointer","hand","enter","over","focus"];
    const cursorDefaultSignals = ["leave","exit","out","default","reset","idle"];

    const normalize = (s) => (typeof s === "string" ? s.trim().toLowerCase() : "");
    const includesAny = (str, signals) => {
      const s = normalize(str);
      return signals.some(t => s.includes(t));
    };

    function handleNamedCursorEvent(evData){
      const name = normalize(evData.name);
      const direct = entryExitCursorEvents.get(name);
      if (typeof direct === "boolean") { setPointer(direct); return true; }

      if (!hoverEventNames.has(name)) return false;
      const p = evData.properties || {};
      const explicit = [p.hover, p.isHover, p.hovering, p.isHovering, p.pointer, p.isPointer]
        .find(v => typeof v === "boolean");
      if (typeof explicit === "boolean") { setPointer(explicit); return true; }

      const text = p.cursor ?? p.Cursor ?? p.intent ?? p.Intent ?? p.state ?? p.State ?? p.message ?? p.Message ?? "";
      if (includesAny(text, cursorDefaultSignals)) { setPointer(false); return true; }
      if (includesAny(text, cursorPointerSignals)) { setPointer(true);  return true; }

      setPointer(true); // fallback for *hov events
      return true;
    }

    function resolveCursorIntent(evData){
      if (handleNamedCursorEvent(evData)) return;

      const p = evData.properties || {};
      const boolHover = [p.hover, p.isHover, p.isHovering, p.hovering].find(v => typeof v === "boolean");
      if (typeof boolHover === "boolean") { setPointer(boolHover); return; }

      const candidates = [
        p.cursor, p.Cursor, p.intent, p.Intent, p.state, p.State, p.message, p.Message, evData.name
      ].filter(v => typeof v === "string");

      if (candidates.some(c => includesAny(c, cursorPointerSignals))) setPointer(true);
      else if (candidates.some(c => includesAny(c, cursorDefaultSignals))) setPointer(false);
    }

    /* ---------- Rive init ---------- */
    r = new rive.Rive({
      src: "/assets/rive/casestudy_v01.riv",
      canvas,
      autoplay: true,
      artboard: "home",
      autoBind: true,
      stateMachines: "mainAnim",
      layout: new rive.Layout({ align: rive.Alignment.Center }),
      onLoad: () => {
        r.resizeDrawingSurfaceToCanvas();
        viewModelInstance = r.viewModelInstance;

        try { viewModelInstance.number("artboardWidth").value  = browserWidth; } catch {}
        try { viewModelInstance.number("artboardHeight").value = browserHeight; } catch {}
        try { viewModelInstance.number("isActive").value = isActive; } catch {}
        try { viewModelInstance.image("video").value = "./preyanPodcasting_03.png"; } catch {}

        initEventBridge();
        setPointer(false);

        try {
          console.log("[Rive] Loaded. Listening for Rive Events.");
          console.log("Artboards:", r.artboardNames);
          console.log("SM Inputs (mainAnim):", r.stateMachineInputs("mainAnim"));
        } catch {}
      },
    });

    function initEventBridge() {
      const { EventType, RiveEventType } = rive;
      r.on(EventType.RiveEvent, (ev) => {
        const data = ev.data;
        if (!data) return;

        if (data.type === RiveEventType.General) {
          resolveCursorIntent(data);
          if (data.name === "nxtPro") console.log("nxtPro triggered");
          if (data.name === "prvPro") console.log("prvPro triggered");
        } else if (data.type === RiveEventType.OpenUrl && data.url) {
          setPointer(false);
          window.location.href = data.url;
        }
      });
    }

    /* ---------- Resize ---------- */
    const resize = () => {
      if (!r) return;
      r.resizeDrawingSurfaceToCanvas();
      ({ browserWidth, browserHeight } = updateBrowserDimensions());
    };
    window.addEventListener("resize", resize);
    addMQListener(window.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`), resize);
  </script>
</body>
</html>
